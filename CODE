// ðŸŸ¢ HABIT TRACKER CONFIGURATION
const fm = FileManager.iCloud();
const directory = fm.documentsDirectory();
const DATA_PATH = fm.joinPath(directory, "habit-tracker.json");

// Constants
const THEME_KEY = "multiHabitTrackerTheme";

// ðŸ”µ URL SCHEME HANDLER
if (args.queryParameters.habitId) {
  const data = loadData();
  const habitId = args.queryParameters.habitId;
  const action = args.queryParameters.action;

  if (action === "increment") {
    const today = formatDate(new Date());
    const habit = data.habits.find(h => h.id === habitId);
    if (habit) {
      if (!habit.history) habit.history = {};
      habit.history[today] = (habit.history[today] || 0) + 1;
      saveData(data);
    }
  }

  Safari.open("scriptable:///run/" + encodeURIComponent(Script.name()));
  Script.complete();
}

const THEMES = {
  dark: { background: "#000000", text: "#ffffff" },
  light: { background: "#ffffff", text: "#454545" }, // alterado aqui
  midnight: { background: "#0D1B2A", text: "#E0E1DD" },
  solarized: { background: "#002B36", text: "#839496" },
  nordic: { background: "#2E3440", text: "#D8DEE9" },
  paper: { background: "#FDF6E3", text: "#586E75" },
  pink: { background: "#FFC0CB", text: "#8B5D68" }
};

const THEME_NAMES = [
  "Classic Dark",
  "Classic Light",
  "Midnight Blue",
  "Solarized Dark",
  "Nordic Night",
  "Paper White",
  "Sweet Pink"
];

// Default Appearance
let COLOR_FILLED = new Color("#ffffff");
let BACKGROUND_COLOR = new Color("#000000");

const MENLO_REGULAR = new Font("Menlo", 8);
const PADDING = 16;
const LINES_SPACING = 6;

// ðŸ”µ THEME MANAGEMENT
function applyTheme(themeKey) {
  const theme = THEMES[themeKey] || THEMES.dark;
  BACKGROUND_COLOR = new Color(theme.background);
  COLOR_FILLED = new Color(theme.text);
}

function loadTheme() {
  try {
    const savedTheme = Keychain.get(THEME_KEY);
    if (savedTheme && THEMES[savedTheme]) {
      applyTheme(savedTheme);
    } else {
      applyTheme("dark");
      Keychain.set(THEME_KEY, "dark");
    }
  } catch (e) {
    console.log("Error loading theme: " + e);
    applyTheme("dark");
  }
}

async function selectTheme() {
  const alert = new Alert();
  alert.title = "Select Theme";
  THEME_NAMES.forEach(name => alert.addAction(name));
  alert.addCancelAction("Cancel");

  const selected = await alert.presentSheet();
  const themeKeys = Object.keys(THEMES);

  if (selected >= 0 && selected < themeKeys.length) {
    const themeKey = themeKeys[selected];
    Keychain.set(THEME_KEY, themeKey);
    applyTheme(themeKey);
    return true;
  }
  return false;
}

// ðŸ”µ DATA MANAGEMENT
function loadData() {
  if (fm.fileExists(DATA_PATH)) {
    try {
      if (!fm.isFileDownloaded(DATA_PATH)) {
        fm.downloadFileFromiCloud(DATA_PATH);
      }
      const raw = fm.readString(DATA_PATH);
      return JSON.parse(raw);
    } catch (e) {
      console.log("Error loading data from iCloud: " + e);
    }
  }
  return initializeData();
}

function saveData(data) {
  fm.writeString(DATA_PATH, JSON.stringify(data, null, 2));
}

function initializeData() {
  const data = {
    habits: [
      { id: "coffee", name: "Coffee", icon: "cup.and.saucer.fill", color: "#6F4E37", target: 4, history: {} },
      { id: "code", name: "Coding", icon: "terminal.fill", color: "#00FF00", target: 5, history: {} }
    ]
  };
  saveData(data);
  return data;
}

// ðŸ”µ HELPER FUNCTIONS
function formatDate(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
}

// ðŸ”µ UI FUNCTIONS
async function manageHabits(data) {
  const alert = new Alert();
  alert.title = "Manage Habits";
  data.habits.forEach(h => alert.addAction(h.name));
  alert.addAction("âž• Add New Habit");
  alert.addCancelAction("Back");

  const idx = await alert.presentSheet();
  if (idx === -1) return;

  if (idx === data.habits.length) {
    await editHabit(data, null);
  } else {
    await editHabit(data, data.habits[idx]);
  }
}

async function editHabit(data, habit) {
  const isNew = !habit;
  const alert = new Alert();
  alert.title = isNew ? "Add Habit" : `Edit ${habit.name}`;

  alert.addTextField("ID (e.g. coffee)", isNew ? "" : habit.id);
  alert.addTextField("Name", isNew ? "" : habit.name);
  alert.addTextField("Icon (SFSymbol)", isNew ? "star.fill" : habit.icon);
  alert.addTextField("Color (Hex)", isNew ? "#ffffff" : habit.color);
  alert.addTextField("Target (Number)", isNew ? "1" : String(habit.target));

  alert.addAction("Save");
  if (!isNew) alert.addDestructiveAction("Delete");
  alert.addCancelAction("Cancel");

  const res = await alert.presentAlert();
  if (res === -1) return;

  if (res === 1 && !isNew) {
    data.habits = data.habits.filter(h => h.id !== habit.id);
    saveData(data);
    return;
  }

  if (res === 0) {
    const newHabit = {
      id: alert.textFieldValue(0),
      name: alert.textFieldValue(1),
      icon: alert.textFieldValue(2),
      color: alert.textFieldValue(3),
      target: parseInt(alert.textFieldValue(4)) || 1,
      history: isNew ? {} : habit.history
    };

    if (isNew) {
      data.habits.push(newHabit);
    } else {
      const index = data.habits.findIndex(h => h.id === habit.id);
      data.habits[index] = newHabit;
    }
    saveData(data);
  }
}

async function manualEntry(data) {
  const alert = new Alert();
  alert.title = "Manual Entry";
  data.habits.forEach(h => alert.addAction(h.name));
  alert.addCancelAction("Cancel");

  const idx = await alert.presentSheet();
  if (idx === -1) return;

  const habit = data.habits[idx];
  const picker = new DatePicker();
  const date = await picker.pickDate();
  const dateStr = formatDate(date);

  const countAlert = new Alert();
  countAlert.title = `Set count for ${habit.name}`;
  countAlert.message = `Date: ${dateStr}`;
  countAlert.addTextField("Count", String(habit.history[dateStr] || 0));
  countAlert.addAction("Save");
  countAlert.addCancelAction("Cancel");

  if (await countAlert.presentAlert() === 0) {
    if (!habit.history) habit.history = {};
    habit.history[dateStr] = parseInt(countAlert.textFieldValue(0)) || 0;
    saveData(data);
  }
}

function createWidget(data) {
  const widget = new ListWidget();
  widget.setPadding(PADDING, PADDING, PADDING, PADDING);
  widget.backgroundColor = BACKGROUND_COLOR;

  const numHabits = data.habits.length;
  const scale = numHabits <= 2 ? 3 : 1;
  const dotSize = 6 * scale;
  const iconSize = 10 * scale;
  const fontSize = 8 * scale;
  const spacing = LINES_SPACING * scale;

  let numDays = 25;
  if (config.widgetFamily === "small") numDays = 8;
  if (config.widgetFamily === "large") numDays = 32;

  const dates = [];
  for (let i = numDays - 1; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    dates.push(formatDate(d));
  }

  data.habits.forEach((habit, idx) => {
    const row = widget.addStack();
    row.layoutHorizontally();
    row.centerAlignContent();
    row.url = `scriptable:///run/${encodeURIComponent(Script.name())}?habitId=${habit.id}&action=increment`;

    const iconSymbol = SFSymbol.named(habit.icon || "star.fill");
    const iconElement = row.addImage(iconSymbol.image);
    iconElement.imageSize = new Size(iconSize, iconSize);
    iconElement.tintColor = new Color(habit.color || "#ffffff");

    row.addSpacer(4 * scale);

    const dotsStack = row.addStack();
    dotsStack.layoutHorizontally();
    dotsStack.centerAlignContent();

    dates.forEach(dateStr => {
      const count = habit.history ? (habit.history[dateStr] || 0) : 0;
      const opacity = Math.min(count / (habit.target || 1), 1.0);

      const dotContainer = dotsStack.addStack();
      dotContainer.size = new Size(8 * scale, dotSize + 4 * scale);
      dotContainer.centerAlignContent();

      const dot = dotContainer.addText("â—");
      dot.font = Font.systemFont(dotSize);

      dot.textColor = new Color(habit.color || "#ffffff", count > 0 ? opacity : 0.15);
    });

    row.addSpacer(4 * scale);

    const todayCount = habit.history ? (habit.history[formatDate(new Date())] || 0) : 0;
    const counterText = row.addText(String(todayCount));
    counterText.font = new Font("Menlo", fontSize);
    counterText.textColor = new Color(habit.color || "#ffffff", 0.5);

    if (idx < numHabits - 1) {
      widget.addSpacer(spacing);
    }
  });

  if (numHabits === 0) {
    const msg = widget.addText("No habits configured.");
    msg.font = MENLO_REGULAR;
    msg.textColor = COLOR_FILLED;
  }

  return widget;
}

// ðŸ”µ MAIN EXECUTION
loadTheme();
const data = loadData();

if (config.runsInApp) {
  const alert = new Alert();
  alert.title = "Habit Tracker Admin";
  alert.addAction("Manage Habits");
  alert.addAction("Manual Entry");
  alert.addAction("Select Theme");
  alert.addAction("Export Data");
  alert.addCancelAction("Exit");

  const selection = await alert.presentSheet();

  if (selection === 0) {
    await manageHabits(data);
  } else if (selection === 1) {
    await manualEntry(data);
  } else if (selection === 2) {
    const themeChanged = await selectTheme();
    if (themeChanged) applyTheme(Keychain.get(THEME_KEY));
  } else if (selection === 3) {
    await Share.file(DATA_PATH);
  }

  const w = createWidget(data);
  await w.presentMedium();
  Script.complete();
} else {
  const w = createWidget(data);
  Script.setWidget(w);
  Script.complete();
}
